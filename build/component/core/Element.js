import{S as t,d as e,a as n,t as i,b as s}from"../Utils-eb9561bf.js";class o{constructor(t=null,e=null){this.inputElement=t,this.outputElement=e}get lioElement(){return"left"===o.InputDirection?this.outputElement:this.inputElement}get rioElement(){return"left"===o.InputDirection?this.inputElement:this.outputElement}}o.InputDirection="left";let l=null;class h extends t{constructor(t=!1){super();const n=document.createElement("f-element");n.element=this;const i=t=>{let e=this;if(t.changedTouches&&t.changedTouches.length>0){const n=t.changedTouches[0];let i=document.elementFromPoint(n.clientX,n.clientY);for(;i&&(!i.element||!i.element.isElement);)i=i.parentNode;e=i?i.element:null}const n=t.type;l="mouseout"===n&&l===e?null:e};!1===t&&(n.ontouchstart=n.onmousedown=t=>{t.stopPropagation()}),n.addEventListener("mouseup",i,!0),n.addEventListener("mouseover",i),n.addEventListener("mouseout",i),n.addEventListener("touchmove",i),n.addEventListener("touchend",i),this.inputs=[],this.links=[],this.dom=n,this.lioLength=0,this.rioLength=0,this.events={connect:[],connectChildren:[],valid:[]},this.node=null,this.style="",this.object=null,this.objectCallback=null,this.enabledInputs=!0,this.visible=!0,this.inputsDOM=n,this.disconnectDOM=null,this.lioDOM=this._createIO("lio"),this.rioDOM=this._createIO("rio"),this.dom.classList.add(`input-${o.InputDirection}`),this.dom.append(this.lioDOM),this.dom.append(this.rioDOM),this.addEventListener("connect",(()=>{e(this.events.connect,this)})),this.addEventListener("connectChildren",(()=>{e(this.events.connectChildren,this)}))}setAttribute(t,e){return this.dom.setAttribute(t,e),this}onValid(t){return this.events.valid.push(t),this}onConnect(t,e=!1){return this.events.connect.push(t),e&&this.events.connectChildren.push(t),this}setObjectCallback(t){return this.objectCallback=t,this}setObject(t){return this.object=t,this}getObject(t=null){return this.objectCallback?this.objectCallback(t):this.object}setVisible(t){return this.visible=t,this.dom.style.display=t?"":"none",this}getVisible(){return this.visible}setEnabledInputs(t){const e=this.dom;return this.enabledInputs||e.classList.remove("inputs-disable"),t||e.classList.add("inputs-disable"),this.enabledInputs=t,this}getEnabledInputs(){return this.enabledInputs}setColor(t){return this.dom.style["background-color"]=n(t),this}setStyle(t){const e=this.dom;return this.style&&e.classList.remove(this.style),t&&e.classList.add(t),this.style=t,this}setInput(t){return"left"===o.InputDirection?this.setLIO(t):this.setRIO(t)}setInputColor(t){return"left"===o.InputDirection?this.setLIOColor(t):this.setRIOColor(t)}setOutput(t){return"left"===o.InputDirection?this.setRIO(t):this.setLIO(t)}setOutputColor(t){return"left"===o.InputDirection?this.setRIOColor(t):this.setLIOColor(t)}get inputLength(){return"left"===o.InputDirection?this.lioLength:this.rioLength}get outputLength(){return"left"===o.InputDirection?this.rioLength:this.lioLength}setLIOColor(t){return this.lioDOM.style["border-color"]=n(t),this}setLIO(t){return this.lioLength=t,this.lioDOM.style.visibility=t>0?"":"hidden",this}getLIOColor(){return this.lioDOM.style["border-color"]}setRIOColor(t){return this.rioDOM.style["border-color"]=n(t),this}getRIOColor(){return this.rioDOM.style["border-color"]}setRIO(t){return this.rioLength=t,this.rioDOM.style.visibility=t>0?"":"hidden",this}add(t){return this.inputs.push(t),t.element=this,this.inputsDOM.append(t.dom),this}setHeight(t){return this.dom.style.height=i(t),this}getHeight(){return this.dom.style.height}connect(t=null){if(null!==this.disconnectDOM&&this.disconnectDOM.dispatchEvent(new Event("disconnect")),null!==t){if(!1===e(this.events.valid,this,t,"connect"))return!1;const n=new o(this,t);if(this.links.push(n),null===this.disconnectDOM){this.disconnectDOM=document.createElement("f-disconnect"),this.disconnectDOM.innerHTML="âœ–",this.dom.append(this.disconnectDOM);const e=()=>{this.links=[],this.dom.removeChild(this.disconnectDOM),this.disconnectDOM.removeEventListener("mousedown",s,!0),this.disconnectDOM.removeEventListener("touchstart",s,!0),this.disconnectDOM.removeEventListener("disconnect",e,!0),t.removeEventListener("connect",n),t.removeEventListener("connectChildren",n),t.removeEventListener("nodeConnect",n),t.removeEventListener("nodeConnectChildren",n),t.removeEventListener("dispose",i),this.disconnectDOM=null},n=()=>{this.dispatchEvent(new Event("connectChildren"))},i=()=>{this.connect()},s=t=>{t.stopPropagation(),this.connect()};this.disconnectDOM.addEventListener("mousedown",s,!0),this.disconnectDOM.addEventListener("touchstart",s,!0),this.disconnectDOM.addEventListener("disconnect",e,!0),t.addEventListener("connect",n),t.addEventListener("connectChildren",n),t.addEventListener("nodeConnect",n),t.addEventListener("nodeConnectChildren",n),t.addEventListener("dispose",i)}}return this.dispatchEvent(new Event("connect")),!0}dispose(){this.dispatchEvent(new Event("dispose"))}serialize(t){const e=this.getHeight(),n=[],i=[];for(const e of this.inputs)n.push(e.toJSON(t).id);for(const e of this.links)null!==e.inputElement&&null!==e.outputElement&&i.push(e.outputElement.toJSON(t).id);this.inputLength>0&&(t.inputLength=this.inputLength),this.outputLength>0&&(t.outputLength=this.outputLength),n.length>0&&(t.inputs=n),i.length>0&&(t.links=i),""!==this.style&&(t.style=this.style),""!==e&&(t.height=e)}deserialize(t){if(void 0!==t.inputLength&&this.setInput(t.inputLength),void 0!==t.outputLength&&this.setOutput(t.outputLength),void 0!==t.inputs){const e=this.inputs;if(e.length>0){let n=0;for(const i of t.inputs)t.objects[i]=e[n++]}else for(const e of t.inputs)this.add(t.objects[e])}if(void 0!==t.links)for(const e of t.links)this.connect(t.objects[e]);void 0!==t.style&&this.setStyle(t.style),void 0!==t.height&&this.setHeight(t.height)}getLinkedObject(t=null){const e=this.getLinkedElement();return e?e.getObject(t):null}getLinkedElement(){const t=this.getLink();return t?t.outputElement:null}getLink(){return this.links[0]}_createIO(t){const{dom:n}=this,i=document.createElement("f-io");i.style.visibility="hidden",i.className=t;const h=h=>{h.preventDefault(),h.stopPropagation(),l=null;const u=this.node.dom;u.classList.add("io-connect"),i.classList.add("connect"),n.classList.add("select");const r="left"===o.InputDirection?"lio":"rio",c=t===r?new o(this):new o(null,this),d=new o(c.inputElement,c.outputElement);this.links.push(c),s(h,(s=>{d.outputElement&&d.outputElement.dom.classList.remove("invalid"),d.inputElement&&d.inputElement.dom.classList.remove("invalid"),d.inputElement=c.inputElement,d.outputElement=c.outputElement,t===r?d.outputElement=l:d.inputElement=l;const o=null!==d.inputElement&&null!==d.outputElement&&d.inputElement.inputLength>0&&d.outputElement.outputLength>0&&!1===e(d.inputElement.events.valid,d.inputElement,d.outputElement,s.dragging?"dragging":"dragged");if(s.dragging&&o)t===r?d.outputElement&&d.outputElement.dom.classList.add("invalid"):d.inputElement&&d.inputElement.dom.classList.add("invalid");else if(!s.dragging&&(u.classList.remove("io-connect"),i.classList.remove("connect"),n.classList.remove("select"),this.links.splice(this.links.indexOf(c),1),null!==l&&!o)){if(c.inputElement=d.inputElement,c.outputElement=d.outputElement,c.outputElement.node.isCircular(c.inputElement.node))return;c.inputElement.inputLength>0&&c.outputElement.outputLength>0&&c.inputElement.connect(c.outputElement)}}),"connecting")};return i.addEventListener("mousedown",h,!0),i.addEventListener("touchstart",h,!0),i}}h.prototype.isElement=!0;export{h as Element};
